<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<script src="https://cdn.tailwindcss.com"></script>
		<style>
/* 套用 Inter 字體 */
body {
	font-family: 'Inter', sans-serif;
	margin: 0;
	padding: 0;
	display: flex;
	justify-content: center;
	align-items: flex-start; /* 讓內容從頂部開始 */
	min-height: 100vh;
	min-width: 100vw;
	background-color: #f0f2f5; /* 淺灰色背景 */
}
	.container {
		background-color: #ffffff;
		border-radius: 4px; /* 圓角 */
		box-shadow: 0 4px 4px rgba(0, 0, 0, 0.1); /* 柔和陰影 */
		padding: 0;
		max-width: 100%; /* 響應式寬度 */
		margin: 0px;
		box-sizing: border-box;
		display: flex;
		flex-direction: column;
		align-items: center;
	}
	canvas {
		border: 0px solid #e0e0e0;
		border-radius: 8px; /* canvas 圓角 */
		max-width: 100%; /* 確保 canvas 響應式 */
		height: auto; /* 維持長寬比 */
		display: block; /* 移除 canvas 下方的額外空間 */
		margin-top: 20px;
		box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); /* 輕微陰影 */
	}
	h1 {
		color: #333;
		text-align: center;
		margin-bottom: 16px;
	}
	.loading-indicator {
		display: flex;
		align-items: center;
		justify-content: center;
		margin-top: 20px;
		font-size: 1.1rem;
		color: #555;
	}
	.spinner {
		border: 4px solid rgba(0, 0, 0, 0.1);
		border-left-color: #3b82f6; /* Tailwind blue-500 */
		border-radius: 50%;
		width: 24px;
		height: 24px;
		animation: spin 1s linear infinite;
		margin-right: 10px;
	}
	@keyframes spin {
		0% { transform: rotate(0deg); }
		100% { transform: rotate(360deg); }
	}
		</style>
	</head>
	<body>
		<div class="container">

			<!-- 載入指示器 -->
			<div id="loading-message" class="loading-indicator">
				<div class="spinner"></div>
				<span>loading PDF ...</span>
			</div>

			<!-- PDF 頁面將被渲染到此容器中 -->
			<div id="pdf-pages-container" class="w-full flex flex-col items-center">
				<!-- Canvas elements will be dynamically added here -->
			</div>
		</div>

		<!-- PDF.js 函式庫 -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
		<script>
			// 設定 PDF.js 的 Worker 來源
			// 這對於 PDF.js 在瀏覽器中正常運作至關重要。
			// 我們使用 CDN 路徑以確保其始終可訪問。
			pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

			// 載入並渲染 PDF 的函式
			async function loadPdf() {
				console.log(location.hash);
				console.log(window.location.hostname);
				console.log(window.location.href);
				const url = `http://${window.location.hostname}:3940/pdf/${location.hash.slice(1)}.pdf`;
				// const url = 'https://mozilla.github.io/pdf.js/web/compressed.tracemonkey-pldi-09.pdf'; // 範例 PDF URL
				const pdfPagesContainer = document.getElementById('pdf-pages-container');
				const loadingMessage = document.getElementById('loading-message');

				try {
					// 顯示載入訊息
					loadingMessage.style.display = 'flex';

					// 取得 PDF 文件
					const doc = await pdfjsLib.getDocument(url).promise;
					console.log('PDF 已載入:', doc);

					const numPages = doc.numPages; // 取得總頁數
					console.log('總頁數:', numPages);

					// 獲取容器的可用寬度作為目標寬度
					// 這裡我們假設 canvas 會有左右各 1.25rem (20px) 的 padding (來自 'px-5' Tailwind class)
					// 因此，實際渲染的 PDF 內容寬度應為容器寬度減去這些 padding。
					const canvasHorizontalPadding = 40; // 20px (left) + 20px (right) = 40px
					const targetWidth = pdfPagesContainer.offsetWidth - canvasHorizontalPadding;

					if (targetWidth <= 0) {
						console.warn("目標寬度為零或負數。PDF 可能無法正確渲染。");
						// 可以考慮在這裡添加一個預設寬度或錯誤處理
					}

					// 遍歷所有頁面並渲染
					for (let pageNum = 1; pageNum <= numPages; pageNum++) {
						// 取得單一頁面
						const page = await doc.getPage(pageNum);
						console.log(`頁面 ${pageNum} 已載入`);

						// 取得原始頁面的視口 (使用預設比例 1)
						const originalViewport = page.getViewport({ scale: 1 });

						// 計算新的比例以符合目標寬度
						// 新比例 = 目標寬度 / 原始頁面寬度
						const scale = targetWidth / originalViewport.width;

						// 取得頁面的視口，使用計算出的比例
						const viewport = page.getViewport({ scale: scale });

						// 建立新的 canvas 元素來渲染當前頁面
						const canvas_id = `pdf-page-${pageNum}`
						var canvas = document.getElementById(canvas_id)
						if (canvas == null) {
							canvas = document.createElement('canvas');
						}
						canvas.id = canvas_id; // 給予唯一的 ID
						// 新增 Tailwind CSS 邊距和左右 padding，以在視覺上與容器邊緣保持間距
						canvas.className = 'my-4 px-5';
						pdfPagesContainer.appendChild(canvas); // 將 canvas 加入容器中

						const context = canvas.getContext('2d');

						// 設定 canvas 尺寸以符合視口
						canvas.height = viewport.height;
						canvas.width = viewport.width;

						// 將頁面渲染到 canvas 上
						const renderContext = {
							canvasContext: context,
							viewport: viewport
						};
						await page.render(renderContext).promise;
						console.log(`頁面 ${pageNum} 渲染成功`);
					}

					// 隱藏載入訊息
					loadingMessage.style.display = 'none';
					for (let pageNum = numPages + 1; document.getElementById(`pdf-page-${pageNum}`) != null; pageNum += 1) {
						document.getElementById(`pdf-page-${pageNum}`).remove()
					}

				} catch (error) {
					console.error('載入或渲染 PDF 時發生錯誤:', error);
				}
			}

			// 當視窗載入完成時呼叫函式以載入 PDF
			window.onload = loadPdf;
			setInterval(() => {loadPdf()}, 2000);
		</script>
	</body>
</html>

